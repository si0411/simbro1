<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, 
user-scalable=no" />
  <title>Notifications</title>
  
  <!-- iOS Web App Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Notifications">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" 
href="https://www.backpackingtours.com/storage/uploads/icons/sale_lhovb.png">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <style>
    body {
      font-family: "SF Pro Display", "SF Pro Text", -apple-system, 
BlinkMacSystemFont, sans-serif;
      background: #f8f8f8;
      margin: 0;
      padding: 1rem;
      padding-top: calc(1rem + env(safe-area-inset-top));
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }
    .status-indicator {
      position: fixed;
      top: calc(10px + env(safe-area-inset-top));
      right: 10px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #4caf50;
      z-index: 1000;
    }
    .status-indicator.checking { background: #ff9800; }
    .status-indicator.error { background: #f44336; }
    .day-header {
      font-size: 0.7rem;
      font-weight: bold;
      margin: 0.5rem 0 0.2rem;
      color: #555;
      background: #eee;
      padding: 0.2rem 0.5rem;
      border-radius: 5px;
    }
    .notification {
      display: flex;
      align-items: flex-start;
      background: white;
      border-radius: 10px;
      padding: 0.3rem;
      margin-bottom: 0.4rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .notification.new {
      animation: shake 0.6s ease-out;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    .icon {
      width: 40px;
      height: 40px;
      min-width: 40px;
      margin-right: 0.7rem;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
    }
    .icon img {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }
    .content {
      flex: 1;
      font-size: 0.8rem;
      min-width: 0;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.2rem;
    }
    .source {
      font-weight: 600;
      font-size: 0.8rem;
      color: #000;
      flex: 1;
      min-width: 0;
    }
    .time {
      font-size: 0.65rem;
      color: #8e8e93;
      font-weight: 400;
      margin-left: 8px;
      flex-shrink: 0;
      background: #f2f2f7;
      padding: 2px 6px;
      border-radius: 8px;
    }
    .message {
      font-size: 0.75rem;
      line-height: 1.3;
      color: #333;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      color: #666;
    }
    .error {
      color: #d32f2f;
      padding: 1rem;
      background: #ffebee;
      border-radius: 8px;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div class="status-indicator" id="statusIndicator"></div>
  <div id="notifications" class="loading">Loading notifications...</div>
  
  <script>
    const ICONS = {
      Sale: 
'https://www.backpackingtours.com/storage/uploads/icons/sale_lhovb.png',
      Form: 
'https://www.backpackingtours.com/storage/uploads/icons/form_oytqc.png',
      Info: 
'https://www.backpackingtours.com/storage/uploads/icons/info_uihmf.png',
      Survey: 
'https://www.backpackingtours.com/storage/uploads/icons/survey_xszot.png',
      Extras: 
'https://www.backpackingtours.com/storage/uploads/icons/extra_jrelk.png'
    };
    const DEFAULT_ICON = ICONS.Info;
    const CSV_URL = '/get-csv';
    const LAST_MODIFIED_URL = '/last-modified';
    const CHECK_INTERVAL = 2000;
    
    let lastTimestamp = 0;
    let isFirstLoad = true;
    let checkInterval;
    
    console.log('App starting...');

    function showDesktopNotification(notification) {
      console.log('Showing notification:', notification.Message);
      
      if ('Notification' in window && Notification.permission === 
'granted') {
        console.log('Creating notification...');
        try {
          const notif = new Notification(notification.Source || 'New 
Notification', {
            body: notification.Message || '',
            icon: ICONS[notification.IconType] || DEFAULT_ICON
          });
          console.log('Notification created');
          setTimeout(() => notif.close(), 5000);
        } catch (e) {
          console.log('Notification failed:', e);
        }
      } else {
        console.log('No notification permission');
      }
    }

    function updateStatusIndicator(status) {
      const indicator = document.getElementById('statusIndicator');
      if (indicator) {
        indicator.className = 'status-indicator ' + status;
      }
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      if (lines.length < 2) return [];
      
      const headers = lines[0].split(',');
      
      return lines.slice(1).map(line => {
        const values = line.split(',');
        const obj = {};
        headers.forEach((h, i) => {
          obj[h.trim()] = (values[i] || '').trim();
        });
        return obj;
      }).filter(obj => obj.Date && obj.Message);
    }

    function formatStoredTime(timeStr) {
      if (!timeStr || timeStr === 'Unknown') return 'Unknown';
      
      try {
        // If it's an ISO string, parse it and format in local time
        if (timeStr.includes('T') || timeStr.includes('-')) {
          const date = new Date(timeStr);
          return date.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          });
        }
        
        // If it's already formatted, return as is
        return timeStr;
      } catch (e) {
        return timeStr;
      }
    }

    function formatDateLabel(dateStr) {
      const today = new Date();
      const d = new Date(dateStr);
      const sameDay = d.toDateString() === today.toDateString();
      return sameDay ? 'Today' : d.toLocaleDateString('en-GB', { weekday: 
'short', day: 'numeric', month: 'short' });
    }

    function groupByDate(data) {
      const grouped = {};
      data.sort((a, b) => new Date(a.Date) - new Date(b.Date));
      data.forEach(n => {
        const date = n.Date || '';
        if (!grouped[date]) grouped[date] = [];
        grouped[date].push(n);
      });
      
      const sortedGrouped = {};
      Object.keys(grouped).sort((a, b) => new Date(a) - new 
Date(b)).forEach(date => {
        sortedGrouped[date] = grouped[date];
      });
      return sortedGrouped;
    }

    function scrollToBottom() {
      setTimeout(() => {
        window.scrollTo({
          top: document.body.scrollHeight,
          behavior: 'smooth'
        });
      }, 100);
    }

    function renderNotifications(data, newNotifications) {
      console.log('Rendering', data.length, 'notifications');
      const container = document.getElementById('notifications');
      const grouped = groupByDate(data);
      let html = '';
      
      Object.keys(grouped).forEach(date => {
        html += '<div class="day-header">' + formatDateLabel(date) + 
'</div>';
        grouped[date].forEach(n => {
          const icon = ICONS[n.IconType] || DEFAULT_ICON;
          const isNew = newNotifications && newNotifications.some(newN => 
            newN.Source === n.Source && newN.Message === n.Message && 
newN.Date === n.Date
          );
          
          // Format the stored time properly
          const displayTime = formatStoredTime(n.Time);
          
          html += '<div class="notification' + (isNew ? ' new' : '') + 
'">';
          html += '<div class="icon"><img src="' + icon + '" alt="' + 
n.IconType + '" /></div>';
          html += '<div class="content">';
          html += '<div class="header">';
          html += '<div class="source">' + (n.Source || '') + '</div>';
          html += '<div class="time">' + displayTime + '</div>';
          html += '</div>';
          html += '<div class="message">' + (n.Message || '') + '</div>';
          html += '</div></div>';
        });
      });
      
      container.className = '';
      container.innerHTML = html || '<div class="error">No notifications 
to display.</div>';
      
      if (isFirstLoad || (newNotifications && newNotifications.length > 
0)) {
        scrollToBottom();
      }
      
      if (newNotifications && newNotifications.length > 0) {
        console.log('Found', newNotifications.length, 'new 
notifications');
        newNotifications.forEach(showDesktopNotification);
      }
      
      setTimeout(() => {
        document.querySelectorAll('.notification.new').forEach(el => 
el.classList.remove('new'));
      }, 1000);
    }

    function checkForUpdates() {
      console.log('Checking for updates...');
      fetch(LAST_MODIFIED_URL)
        .then(res => res.json())
        .then(data => {
          if (data.success && (data.timestamp !== lastTimestamp || 
isFirstLoad)) {
            console.log('Changes detected');
            loadFullNotifications();
            lastTimestamp = data.timestamp;
          }
          updateStatusIndicator('');
        })
        .catch(err => {
          console.log('Update check failed:', err);
          if (isFirstLoad) loadFullNotifications();
          updateStatusIndicator('error');
        });
    }

    function loadFullNotifications() {
      console.log('Loading notifications...');
      updateStatusIndicator('checking');
      
      fetch(CSV_URL)
        .then(res => res.text())
        .then(text => {
          console.log('Got CSV data');
          const data = parseCSV(text);
          
          if (isFirstLoad) {
            renderNotifications(data);
            isFirstLoad = false;
          } else {
            const previousData = 
JSON.parse(localStorage.getItem('lastNotifications') || '[]');
            const newNotifications = data.filter(item => 
              !previousData.some(prev => 
                prev.Source === item.Source && prev.Message === 
item.Message && prev.Date === item.Date
              )
            );
            
            renderNotifications(data, newNotifications);
          }
          
          localStorage.setItem('lastNotifications', JSON.stringify(data));
          updateStatusIndicator('');
        })
        .catch(err => {
          console.log('Load failed:', err);
          updateStatusIndicator('error');
          if (isFirstLoad) {
            document.getElementById('notifications').innerHTML = '<div 
class="error">Failed to load</div>';
          }
        });
    }

    function startMonitoring() {
      console.log('Starting...');
      checkForUpdates();
      checkInterval = setInterval(checkForUpdates, CHECK_INTERVAL);
    }

    document.addEventListener('DOMContentLoaded', startMonitoring);
  </script>
</body>
</html>
